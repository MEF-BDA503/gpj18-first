---
title: "fiRst Group Project"
author: "Group fiRst"
output: html_document
---
# fiRst Group Project 

Here are our required libraries;

```{r setup, message=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning=FALSE)
library(tidyverse)
library(readxl)
library(forcats)
library(rlang)
library(scales)
library(knitr)
library(lubridate)
library(RColorBrewer)
library(plotly)
library(stringr)
library(data.table)
library(kableExtra)
library(splitstackshape)
library(grid)
library(gridExtra)
library(dplyr)
```

## Dataset Overview

We obtained energy plant cuts data in Turkey between 2012 and 2018 from the Energy Transparency Platform. Data contains 73311 rows and 7 variables.

Objectives of this project is as follows:

# Learning Objectives
* Cleaning dirty data and doing text mining in order to extract insights.
* Visualizing data according to different variables.
* Performing exploratory and explanatory analysis on a mostly untidy dataset.

# Analysis Objectives
* Finding longest and shortest cuts and visualizing them.
* Visualizing cuts at the power plants according to plant, plant type and duration.
* Finding top reasons of electricity cuts with tidy text mining.
* Analyzing cuts vis-a-vis to capacity and total power at the power plant.

```{r Getting the Data, message=FALSE}
# Create a temporary file
tmp<-tempfile(fileext=".csv")
# Download file from repository to the temp file
download.file("https://github.com/MEF-BDA503/gpj18-first/blob/master/dataset_candidates/ArizaBakim-01012008-25112018.csv?raw=true",destfile=tmp)
```

```{r Initial Cleaning and Analysis}
# Reading data. Encoding as Latin-1 is crucial in order to see Turkish characters properly.
cuts<-read.csv(tmp, encoding= "Latin-1", sep = ";")
colnames(cuts) <-c("Plant.Name","UEVCB","Start.Date","End.Date","Established.Power","Power.atOutage","Reason")
# Checking what we have as data.
str(cuts)
# Change type of time and date
cuts$Start.Date <- dmy_hm(cuts$Start.Date)
cuts$End.Date<- dmy_hm(cuts$End.Date)
# Turn power capacity variables into numeric
cuts$Established.Power <- str_replace(cuts$Established.Power,"[:punct:]","") 
cuts$Power.atOutage <- str_replace(cuts$Power.atOutage,"[:punct:]","") 
cuts$Established.Power <- str_replace(cuts$Established.Power,",","") 
cuts$Power.atOutage <- str_replace(cuts$Power.atOutage,",","")
cuts$Established.Power <- as.factor(cuts$Established.Power)
cuts$Power.atOutage <- as.factor(cuts$Power.atOutage)
cuts$Established.Power <-as.numeric(levels(cuts$Established.Power))[cuts$Established.Power]
cuts$Power.atOutage <-as.numeric(levels(cuts$Power.atOutage))[cuts$Power.atOutage]

cuts[c("Established.Power","Power.atOutage")]<-cuts[c("Established.Power","Power.atOutage")]/100
# Removing data that contains NA's.
cuts <- na.omit(cuts)
#Drop UEVÇB column, we do not think it will be any help for analysis.
cuts <- subset(cuts, select=-UEVCB)
# Let's check the data for yearly total cuts.
yearly_cuts <- cuts %>% group_by(year=floor_date(Start.Date,"year")) %>% summarize(Start.Date=n())
yearly_cuts
```

Look like there is an average of 10-12k cuts per year in the database with the exception of 2018, where the number of cuts seems to be much higher. We believe this is simply the result of transparency platform adding more data from plants or more plants all together to its database in 2018 to make it more thorough.

```{r Plot}
# Let's put the yearly cuts into a bar graph.
ggplot(data=yearly_cuts, aes(y=Start.Date, x=factor(year(year)), fill=factor(year(year))))+
  geom_bar(stat="identity")+
  labs(x="Year", y="Incident Count", title="Yearly Total Incidents")+
  theme_light()+
  scale_fill_brewer(palette="PuBuGn")+
  theme(legend.position="none")
```

# Data Preprocessing and Wrangling

The database has mostly text based data. Initial overview of the database shows a lot of errors, some of which come from localization problems, others simply misspelled. In this part, we've attempted to make it more tidy by making plant names more distinct, cut reasons more clear.

```{r New Variables For Calculations}
#Adding süre variable as duration of the cuts as hours and capacity usage ratio at time of cut as capacity usage's ratio to total capacity.

cuts <- cuts %>% mutate(sure = difftime(End.Date,Start.Date,units="hours")) %>% mutate(kapasiteorani = Power.atOutage / Established.Power)
#cuts$kapasiteorani <- percent(cuts$kapasiteorani)
# Make all strings lower case so that can be cleaned easier.
cuts <- cuts %>% mutate_at(.vars=c("Plant.Name", "Reason"), funs(str_to_lower(.,locale="tr")))

#With new variables let's see our data.
kable(cuts[1:5,]) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

```{r Wrangle}
#Detect similiar names with Fuzzy Text matching
uniqueNames <- unique(cuts$Plant.Name)
name_distances <- list()
i <- 1
for (ind in uniqueNames){
  name_distances[[i]] <- agrep(ind, uniqueNames, value=T)
  i <- i+1
}
name_distances <- unique(Filter(function(x) {length(x) > 1}, name_distances))
#Fixing detected string issues.
cuts$Plant.Name <- cuts$Plant.Name %>% 
  str_replace_all("[Ýý]", "i") %>%
  str_replace_all("enerj.sa", "enerjisa") %>%
  str_replace_all("yeniköy ts", "yeniköy tes") %>%
  str_replace_all("^ova elektrik", "gebze ova elektrik") %>%
  str_replace_all("yataðan .*", "yataðan tes") %>%
  str_replace_all("köklüce$", "köklüce hes") %>%
  str_replace_all(".* entek", "entek") %>%
  str_replace_all("kürtün-hes", "kürtün hes") %>%
  str_replace_all("^rwe_turcas_guney", "denizli rwe_turcas_guney") %>%
  str_replace_all("tekirdað santrali.*", "modern enerji tekirdað santrali") %>%
  str_replace_all("karadað$", "karadað res") %>%
  str_replace_all(".?menzelet( hes)?", "menzelet hes") %>%
  str_replace_all("\\.", "") %>%
  str_replace_all("hidro(\\s?elektrik santral[ýi]| e\\.?s)", " hes") %>%
  str_replace_all("(termik santral[ýi]|\\sts\\s?)", " tes") %>%
  str_replace_all("tunçbilektes", "tunçbilek tes") %>%
  str_replace_all("d.*(k.*)?ç.*(s.*)?", "dgkç") %>%
  str_replace_all("jeotermal (e.*s.*)", "jes")
  
cuts$Reason <- cuts$Reason %>%
  str_replace_all("[Ýý]", "i") %>%
  str_replace_all("t(.r|r.)b.n", "türbin") %>%
  str_replace_all("ar.zas.?.?", "ariza") %>%
  str_replace_all("so.utma", "sogutma") %>%
  str_replace_all("(?<!\\d)\\.", "") %>%
  str_replace_all(".n.te", "unite") %>%
  str_replace_all("reg.lat.r", "regulator")
```

In order to categorise the reasons, we performed a word count Gerekçe column, laying out most encountered words.

```{r Word count of cut reasons}
gerekcewordcount <- cSplit(cuts, "Reason", sep = " ", direction = "long") %>%
      group_by(Reason) %>%
      summarise(Count = n())
arrange(gerekcewordcount,desc(Count))
```

Based on the plant name, we created a new column called Plant.Type which stores the type of the plant.

The abbreviations are as following:
HES : Hydroelectricty Plant
RES : Wind Energy Plant
TES : Thermal Power Plant
DGKÇ: Natural Gas Combined Cycle Power Plant
JES : Geothermal Energy Plant
BES : Biomass Energy Plant/Biogas Plant

```{r categorise Plant type}
#Categorising type of plants so we can do type based analysis later on.
cuts<- cuts %>%
  mutate(Plant.Type=ifelse(grepl("hes", cuts$Plant.Name, ignore.case = T), "HES", 
         (ifelse(grepl(" res\\s?|rüzgar", cuts$Plant.Name, ignore.case = T), "RES",
         (ifelse(grepl("( tes\\s?|termik santral|ithal kömür|bolu göynük|eskiþehir endüstriyel|aliaða çakmaktepe|enerjisa tufanbeyli|ataer)", cuts$Plant.Name, ignore.case = T), "TES",
         (ifelse(grepl("(d.*k.*ç.*(s.*)?|bosen|acarsoy denizli|akenerji|ambarli|m.*osb|kombine|paner|enerjisa (bandirma|kentsa)|kojsant|zorlu enerji|rwe_turcas|kojen|ugur enerji|isbirligi-enerji|gebze ova elektrik)", cuts$Plant.Name, ignore.case = T), "DGKÇ",
         (ifelse(grepl("(jes|jeotermal)", cuts$Plant.Name, ignore.case =T), "JES",
         (ifelse(grepl("biyokütle|biogaz", cuts$Plant.Name, ignore.case =T), "BES",       
                "Other"))))))))))))
cuts$Plant.Type <- as.factor(cuts$Plant.Type)
```

# Data Analysis

## Initial Exploration
Let's take a look at our final dataset.

```{r Explore}
str(cuts)
```

Here are the explanations for variables:

Santral Ýsmi              : Name of the power plant.
Olay baþlangýç tarihi     : Start date time of the cut.
Olay bitiþ tarihi         : End date/time of the cut.
Ýþletmedeki kurulu güç    : Total power at the plant.
Olay sýrasýndaki kapasite : Capacity at the time of incident
Gerekçe                   : Reason of the cut
sure                      : Length of the cut in hours.
kapasiteorani             : Proportion of the capacity at the time of the cut to max capacity.
Type                      : Type of the plant

```{r Capacity of Plants based on type}
cuts %>%
  select(Plant.Type, Plant.Name, Established.Power) %>%
  distinct(Plant.Name, Plant.Type, Established.Power) %>%
  group_by(Plant.Type) %>%
  summarize(Mean=mean(Established.Power), Total=sum(Established.Power)) %>%
    ggplot(.)+
    geom_bar(aes(x=reorder(Plant.Type, -Mean), y=Mean, fill=Plant.Type), stat="identity")+
    geom_text(aes(x=Plant.Type, y=Total/100, label=signif(Total, 2)))+
    labs(x="", y="Average Power Output MWe", title="Power Output Based on Plant Type in Turkey", x="Plant Type")+
    theme_light()+
    scale_fill_brewer(palette="Greens")+
    theme(legend.position="none")+
    scale_y_continuous(sec.axis=sec_axis(~.*100, name="Total Power Output MWe"))
```

While the average capacity of Thermal and NGCC plants are much higher than other plant types, Hydroelectricity plants provide majority of the energy demand of Turkey. Geothermal, Wind and Bioenergy Plants have little contribution on Turkey's energy output. There are no registered Solar Energy Plants.

There are two types of cuts at the overall level. Either due to a malfunction or due to a planned activity such as turnaround maintenances, tests, capacity reductions due to economic reasons or supply demand balance etc. Let's separate them according to type of cut. We searched for words that imply an planned activity at the reason of cut and assigned "Planned Activity" as variable to a new column. All others are assigned to "Malfunction".

```{r Types of Cuts}
cuts <- cuts%>% mutate(TypeofCut=ifelse(grepl("(bak.m|[cç]al[ýi][sþ]ma|devreye alma|yük alma|test|planl[ýi]|devre di[sþ]i)", Reason, ignore.case = T, perl=T), "Planned Activity", "Malfunction"))
```

## Analysis on Malfunctions

Our histogram that shows distribution of the cuts durations looks messy due to outliers. Here is a quick workaround by fixing outliers to a maximum value inspired by https://edwinth.github.io/blog/outlier-bin/. Same person has a nice package to deal with such situations, however its dependencies does not work with Shiny.

It looks like number of cuts are mostly between 0-5 hour with some outliers. Looks like most malfunctions are solved in less than 5 hours.When we look at the capacity usage ratio at the malfunctions, there is a stack between 0-10%. However except that distribution is close to normal.

```{r Visualizing Duration of Cuts and Capacity Usage Ratio According to Cut Type}
cuts %>% mutate(sure_outlierfixed = ifelse(sure > 24, 24, sure))%>%
ggplot(aes(x=sure_outlierfixed))+
  geom_histogram()+
  facet_wrap(~TypeofCut)

#Note this part has to be polished.
cuts$kapasiteorani <- as.numeric(sub("%","",cuts$kapasiteorani))/100
ggplot(cuts,aes(x=kapasiteorani))+
  geom_histogram()+
  facet_wrap(~TypeofCut)+
    scale_x_continuous(limits = c(0,1))
```

Let's see how many malfunctions the power plants have reported since late 2014.

```{r Malfunction Count}
#Gather plants that reported more than 1000 malfunctions in the last 6 years
m_count <- cuts %>%
  filter(TypeofCut=="Malfunction") %>%
  group_by(Plant.Name) %>%
  summarize(m_count=n()) %>%
  arrange(desc(m_count)) %>%
  filter(m_count >= 1000)
m_plants <- as.vector(m_count$Plant.Name)
malf <- cuts %>%
  filter(Plant.Name %in% m_plants, TypeofCut=="Malfunction") %>%
  mutate(quarter=lubridate::quarter(Start.Date, with_year = T)) %>%
  group_by(Plant.Name, quarter) %>%
  summarize(malf=n())
malf$quarter=as.character(malf$quarter)    

ggplotly(
ggplot(malf, aes(x=quarter))+
  coord_flip()+
  theme_bw()+
  geom_bar(aes(y=malf, fill=Plant.Name), stat="identity")+
  theme(legend.position = "bottom", legend.title = element_text("Plant Name"))+
  labs(x="Quarter", y="Malfunction Count", title="Quarterly Fault Count of Top Frequently Malfunctioning Plants")
)
```


When we look at the graph, we can roughly see that thermal plants make up most of the top malfunctioning plants in Turkey. 2018's 3rd quarter showed a spike in reported malfunctions, from our graph it seems like two major plants had numerous faults during this quarter, eren enerji and sebenoba reporting 502 and 482 cuts, respectively. 
A power plant is a huge facility that utilizes large numbers of various equipments. A fault may occur on any of them. So, to get a more explanatory outcome, we've decided to categorise these cuts by malfunction type based on the reason written.

```{r Malfunction category}
#Categorise malfunctions
catmalf <- cuts %>%
  filter(TypeofCut=="Malfunction") %>%
  mutate(Malf.Category =ifelse(grepl("(t.rb[ýi]n|g.?t.|kompr[ae]s[oö]r|pompa|fan|de[gð]irmen|vibrasyon|makin[ea]|trip|motor|govern[oöe]r|ate[sþ\\?]leme|ayar kanat?|hidrolik start|c[uü]ruf)", Reason, ignore.case = T, perl=T), "Rotating Equipment Failure",
           (ifelse(grepl("(reg[uü]lat[oö]r|trafo|(elektrik|enerji) kesinti|so[gð]utma su.?.?|[gj]enerat[oö]r|elektriksel|154|bara|[sþ]ebeke|santral)", Reason, ignore.case = T, perl=T), "Electrical or Other Utilities Failure",   
           (ifelse(grepl("((?<!\\w)su |k[oö\\?]m[üu\\?]r|gaz basin[çc]?)", Reason, ignore.case = T, perl=T), "Feedstock Issues",
           (ifelse(grepl("(vana|kazan|boru|hatt[ýi]|e[þs]anjör|val(f|ve)|kablo|air preheater|ka.ak)", Reason, ignore.case = T, perl=T), "Static Equipment Failure", 
           (ifelse(grepl("(plc|dcs|haberle[þs]me|otom[oa]syon|scada|[ei]nstr[uü]?m.{2,3} (hava|air)|[\\?i]kaz)", Reason, ignore.case = T, perl=T), "Control and Automation Systems Failure",
           (ifelse(grepl("(bo[ðg]ulma|çiftçi|ara[çc] dü[þs]|tarim|atmosfer(ik)?|ya[gð][ýi][þs])", Reason, ignore.case = T, perl=T), "Outside Factors",
           (ifelse(grepl("(^(sistem )?ar.za(si|nin)?( devam.)?$|^$|[uü]nite ar[ýi]za(s[iý])?)", Reason, ignore.case = T, perl=T), "Unspecified",
                "Other"))))))))))))))
```

So now there are several different malfunction types from rotating equipments such as pumps, turbines to static equipments like pipelines and heat exchangers. Electrical or other utility based cuts are numerous too, note that electrical failures here are problems in electricity that power plant equipments use, not the electricity they produce, therefore they are counted as utilities. There are a few strange cases too, a hydroelectricity power plant shutting down due to a car falling into the dam lake is one of such cases.

```{r malf_pie}
m_by_type<- catmalf %>% 
  group_by(Plant.Type, Malf.Category) %>%
  filter(Plant.Type!="Other")%>%
  count() %>%
  ungroup()%>%
  group_by(Plant.Type)%>%
  mutate(perc=`n`/sum(`n`))

#Plot pie charts for most occured malfunction type
plot_ly(textposition = 'inside',
        textinfo = 'label+percent',
        insidetextfont = list(color = '#FFFFFF'),
        marker = list(colors = colors,
                      line = list(color = '#FFFFFF', width = 1))) %>%
  add_pie(data = subset(m_by_type, Plant.Type=="TES"), labels = ~Malf.Category, values = ~n,
          name = "Thermal Energy Plant", domain = list(x = c(0, 0.35), y = c(0.50, 0.95))) %>%
  add_pie(data = subset(m_by_type, Plant.Type=="HES"), labels = ~Malf.Category, values = ~n,
          name = "Hydroelectricity Plant", domain = list(x = c(0.35, 1), y = c(0.50, 0.95))) %>%
  add_pie(data = subset(m_by_type, Plant.Type=="RES"), labels = ~Malf.Category, values = ~n,
          name = "Wind Energy Plant", domain = list(x = c(0, 0.35), y = c(0, 0.45))) %>%
  add_pie(data = subset(m_by_type, Plant.Type=="JES"), labels = ~Malf.Category, values = ~n,
          name = "Geothermal Energy Plant", domain = list(x = c(0.35, 1), y = c(0, 0.45))) %>%
  layout(title = "Malfunction Type by Plant", showlegend = F,
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = TRUE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         annotations = list(
      list(x = 0.09 , y = 1.0, text = "Thermal Energy Plant", showarrow = F, xref='paper', yref='paper'),
      list(x = 0.8 , y = 1.0, text = "Hydroelectricity Plant", showarrow = F, xref='paper', yref='paper'),
      list(x = 0.1 , y = 0.47, text = "Wind Turbine", showarrow = F, xref='paper', yref='paper'),
      list(x = 0.8 , y = 0.47, text = "Geothermal Energy Plant", showarrow = F, xref='paper', yref='paper')))
```


Thermal Plants have suffered from static equipment and rotating equipment failures almost in equal cases, hydroelectricty plants have had many electrical and utility issues. Being mostly comprised of rotating equipments, wind turbines' majority of problems come from rotating equipments and among the reports of geothermal plants, almost half of them were electrical or other utility problems.



```{r, include=FALSE}
otherana <- catmalf %>%
  filter(Malf.Category=="Other")
gerekcewordcountm <- cSplit(otherana, "Reason", sep = " ", direction = "long") %>%
      group_by(Reason) %>%
      summarise(Count = n())
colors <- c('#4AC6B7', '#1972A4', '#965F8A', '#FF7070', '#C61951')

```


Refs

https://plot.ly/r/bubble-charts/
https://edwinth.github.io/blog/outlier-bin/