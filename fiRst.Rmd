---
title: "InitialAnalysis"
author: "Group fiRst"
output: html_document
---
# fiRst Group Project 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning=FALSE)
library(tidyverse)
library(readxl)
library(forcats)
library(rlang)
library(scales)
library(knitr)
library(lubridate)
library(RColorBrewer)
library(plotly)
library(stringr)
library(data.table)
library(kableExtra)
library(splitstackshape)
```

## Dataset Overview

We obtained energy plant cuts data in Turkey between 2012 and 2018 from the Energy Transparency Platform. Data contains 73311 rows and 7 variables.

Objectives of this project is as follows:

# Learning Objectives
* Cleaning dirty data and doing text mining in order to extract insights.
* Visualizing data according to different variables.
* Performing exploratory and explanatory analysis on a mostly untidy dataset.

# Analysis Objectives
* Finding longest and shortest cuts and visualizing them.
* Visualizing cuts at the power plants according to plant, plant type and duration.
* Finding top reasons of electricity cuts with tidy text mining.
* Analyzing cuts vis-a-vis to capacity and total power at the power plant.

```{r Getting the Data}
# Create a temporary file
tmp<-tempfile(fileext=".csv")
# Download file from repository to the temp file
download.file("https://github.com/MEF-BDA503/gpj18-first/blob/master/dataset_candidates/ArizaBakim-01012008-25112018.csv?raw=true",destfile=tmp)
```

```{r Initial Cleaning and Analysis}
# Reading data. Encoding as Latin-1 is crucial in order to see Turkish characters properly.
cuts<-read.csv(tmp, encoding= "Latin-1", sep = ";")
colnames(cuts) <-c("Plant.Name","UEVCB","Start.Date","End.Date","Established.Power","Power.atOutage","Reason")
# Checking what we have as data.
str(cuts)
# Change type of time and date
cuts$Start.Date <- dmy_hm(cuts$Start.Date)
cuts$End.Date<- dmy_hm(cuts$End.Date)
# Turn power capacity variables into numeric
cuts$Established.Power <- str_replace(cuts$Established.Power,"[,\\.]","") 
cuts$Power.atOutage <- str_replace(cuts$Power.atOutage,"[,\\.]","") 
cuts$Established.Power <- as.factor(cuts$Established.Power)
cuts$Power.atOutage <- as.factor(cuts$Power.atOutage)
cuts$Established.Power <-as.numeric(levels(cuts$Established.Power))[cuts$Established.Power]
cuts$Power.atOutage <-as.numeric(levels(cuts$Power.atOutage))[cuts$Power.atOutage]

#cuts[c("Established.Power","Power.atOutage")]<-cuts[c("Established.Power","Power.atOutage")]/100
# Removing data that contains NA's.
cuts <- na.omit(cuts)
#Drop UEVÇB column, we do not think it will be any help for analysis.
cuts <- subset(cuts, select=-UEVCB)
# Let's check the data for yearly total cuts.
yearly_cuts <- cuts %>% group_by(year=floor_date(Start.Date,"year")) %>% summarize(Start.Date=n())
yearly_cuts
```

Look like there is an average of 10-12k cuts per year in the database with the exception of 2018, where the number of cuts seems to be much higher. We believe this is simply the result of transparency platform adding more data from plants or more plants all together to its database in 2018 to make it more thorough.

```{r Plot}
# Let's put the yearly cuts into a bar graph.
ggplot(data=yearly_cuts, aes(y=Start.Date, x=factor(year(year)), fill=factor(year(year))))+
  geom_bar(stat="identity")+
  labs(x="Year", y="Incident Count", title="Yearly Total Incidents")+
  theme_light()+
  scale_fill_brewer(palette="PuBuGn")+
  theme(legend.position="none")
```
# Data Wrangling

The database has mostly text based data. Initial overview of the database shows a lot of errors, some of which come from localization problems, others simply misspelled. In this part, we've attempted to make it more tidy by making plant names more distinct, cut reasons more clear.

```{r New Variables For Calculations}
#Adding süre variable as duration of the cuts as hours and capacity usage ratio at time of cut as capacity usage's ratio to total capacity.

cuts <- cuts %>% mutate(sure = difftime(End.Date,Start.Date,units="hours")) %>% mutate(kapasiteorani = Power.atOutage / Established.Power)
cuts$kapasiteorani <- percent(cuts$kapasiteorani)
# Make all strings lower case so that can be cleaned easier.
cuts <- cuts %>% mutate_at(.vars=c("Plant.Name", "Reason"), funs(tolower)) 

#With new variables let's see our data.
kable(cuts[1:5,]) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

```

```{r Wrangle}
#Detect similiar names with Fuzzy Text matching
uniqueNames <- unique(cuts$Plant.Name)
name_distances <- list()
i <- 1
for (ind in uniqueNames){
  name_distances[[i]] <- agrep(ind, uniqueNames, value=T)
  i <- i+1
}
name_distances <- unique(Filter(function(x) {length(x) > 1}, name_distances))
#Fixing detected string issues.
cuts$Plant.Name <- cuts$Plant.Name %>% 
  str_replace_all("[İı]", "i") %>%
  str_replace_all("enerj.sa", "enerjisa") %>%
  str_replace_all("yeniköy ts", "yeniköy tes") %>%
  str_replace_all("^ova elektrik", "gebze ova elektrik") %>%
  str_replace_all("yatağan .*", "yatağan tes") %>%
  str_replace_all("köklüce$", "köklüce hes") %>%
  str_replace_all(".* entek", "entek") %>%
  str_replace_all("kürtün-hes", "kürtün hes") %>%
  str_replace_all("^rwe_turcas_guney", "denizli rwe_turcas_guney") %>%
  str_replace_all("tekirdağ santrali.*", "modern enerji tekirdağ santrali") %>%
  str_replace_all("karadağ$", "karadağ res") %>%
  str_replace_all(".?menzelet( hes)?", "menzelet hes") %>%
  str_replace_all("\\.", "") %>%
  str_replace_all("hidro(\\s?elektrik santral[ıi]| e\\.?s)", " hes") %>%
  str_replace_all("(termik santral[ıi]|\\sts\\s?)", " tes") %>%
  str_replace_all("tunçbilektes", "tunçbilek tes") %>%
  str_replace_all("d.*(k.*)?ç.*(s.*)?", "dgkç") %>%
  str_replace_all("jeotermal (e.*s.*)", "jes")
  
cuts$Reason <- cuts$Reason %>%
  str_replace_all("[İı]", "i") %>%
  str_replace_all("t(.r|r.)b.n", "türbin") %>%
  str_replace_all("ar.zas.?.?", "ariza") %>%
  str_replace_all("so.utma", "sogutma") %>%
  str_replace_all("(?<!\\d)\\.", "") %>%
  str_replace_all(".n.te", "unite") %>%
  str_replace_all("reg.lat.r", "regulator")
```

In order to categorise te reasons, we performed a word count Gerekçe column, laying out most encountered words.

```{r Word count of cut reasons}
gerekcewordcount <- cSplit(cuts, "Reason", sep = " ", direction = "long") %>%
      group_by(Reason) %>%
      summarise(Count = n())
arrange(gerekcewordcount,desc(Count))
```

Based on the plant name, we created a new column called Type which stores the type of the plant.

The abbreviations are as following:
HES : Hydroelectricty Plant
RES : Wind Energy Plant
TES : Thermal Power Plant
DGKÇ: Natural Gas Combined Cycle Plant
JES : Geothermal Energy Plant
BES : Biomass Energy Plant

```{r categorise Plant type}
#Categorising type of plants so we can do type based analysis later on.
cuts$Type <- ifelse(grepl(" hes\\s?", cuts$Plant.Name, ignore.case = T), "HES", 
         (ifelse(grepl(" res\\s?", cuts$Plant.Name, ignore.case = T), "RES",
         (ifelse(grepl(" tes\\s?", cuts$Plant.Name, ignore.case = T), "TES",
         (ifelse(grepl(" a?d.*k.*ç.*(s.*)?", cuts$Plant.Name, ignore.case = T), "DGKÇ",
         (ifelse(grepl("(jes\\s|jeotermal)", cuts$Plant.Name, ignore.case =T), "JES",
         (ifelse(grepl("biyokütle", cuts$Plant.Name, ignore.case =T), "BES",       
                "Other")))))))))))
cuts$Type <- as.factor(cuts$Type)
```

# Data Analysis

Let's take a look at our final dataset.

```{r Explore}
str(cuts)
```

Here are the explanations for variables:

Santral İsmi              : Name of the power plant.
Olay başlangıç tarihi     : Start date time of the cut.
Olay bitiş tarihi         : End date/time of the cut.
İşletmedeki kurulu güç    : Total power at the plant.
Olay sırasındaki kapasite : Capacity at the time of incident
Gerekçe                   : Reason of the cut
sure                      : Length of the cut in hours.
kapasiteorani             : Proportion of the capacity at the time of the cut to max capacity.
Type                      : Type of the plant

```{r Capacity of Plants based on type}
cuts %>%
  group_by(Type) %>%
  summarize(Mean=mean(Established.Power)) %>%
  ggplot(., aes(x=reorder(Type, -Mean), y=Mean, fill=Type))+
    geom_bar(stat="identity")+
    labs(x="Plant Type", y="Power Output MWe", title="Average Power Output Based on Plant Type in Turkey")+
    theme_light()+
    scale_fill_brewer(palette="Greens")+
    theme(legend.position="none")
```

There are two types of cuts at the overall level. Either due to a malfunction or due to planned maintenance. Let's separate them according to type of cut. We searched for words "bakim" at the reason of cut and assigned "Planned Maintenance" as variable to a new column. All others are assigned "Malfunction".

```{r Types of Cuts}
bakim <- c("bakim","bakim")
cuts <- cuts%>% mutate(TypeofCut= ifelse(str_detect(Reason,paste(bakim,collapse="|")),"Planned Maintenance","Malfunction"))

```

Our histogram that shows distribution of the cuts durations looks messy due to outliers. Here is a quick workaround by fixing outliers to a maximum value inspired by https://edwinth.github.io/blog/outlier-bin/. Same person has a nice package to deal with such situations, however its dependencies does not work with Shiny.

It looks like number of cuts are mostly between 0-5 hour with some outliers. Looks like most malfunctions are solved in less than 5 hours.When we look at the capacity usage ratio at the malfunctions, there is a stack between 0-10%. However except that distribution is close to normal.
```{r Visualizing Duration of Cuts and Capacity Usage Ratio According to Cut Type}
cuts %>% mutate(sure_outlierfixed = ifelse(sure > 24, 24, sure))%>%
ggplot(aes(x=sure_outlierfixed))+
  geom_histogram()+
  facet_wrap(~TypeofCut)

#Note this part has to be polished.
cuts$kapasiteorani <- as.numeric(sub("%","",cuts$kapasiteorani))/100
ggplot(cuts,aes(x=kapasiteorani))+
  geom_histogram()+
  facet_wrap(~TypeofCut)+
    scale_x_continuous(limits = c(0,1))


```



