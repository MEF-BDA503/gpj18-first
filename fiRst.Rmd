---
title: "InitialAnalysis"
author: "Efehan DanÄ±ÅŸman"
date: "11 KasÄ±m 2018"
output: html_document
---
# fiRst Group Project 

```{r setup, include=FALSE,eval=TRUE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(forcats)
library(scales)
library(knitr)
library(lubridate)
library(RColorBrewer)
library(plotly)
library(stringr)
library(splitstackshape)
```

## Dataset Overview

We obtained energy plant cuts data in Turkey between 2012 and 2018 from the Energy Transparency Platform. Data contains 73311 rows and 7 variables.

Objectives of this project is as follows:

# Learning Objectives
* Cleaning dirty data and doing text mining in order to extract insights.
* Visualizing data according to different variables.
* Performing exploratory and explanatory analysis on a mostly untidy dataset.

# Analysis Objectives
* Finding longest and shortest cuts and visualizing them.
* Visualizing cuts at the power plants according to plant, plant type and duration.
* Finding top reasons of electricity cuts with tidy text mining.
* Analyzing cuts vis-a-vis to capacity and total power at the power plant.

```{r Getting the Data}
# Create a temporary file
tmp<-tempfile(fileext=".csv")
# Download file from repository to the temp file
download.file("https://github.com/MEF-BDA503/gpj18-first/blob/master/dataset_candidates/ArizaBakim-01012008-25112018.csv?raw=true",destfile=tmp)
```

```{r Initial Cleaning and Analysis}
# Reading data. Encoding as Latin-1 is crucial in order to see Turkish characters properly.
cuts<-read.csv(tmp, encoding= "Latin-1", sep = ";")
# Checking what we have as data.
str(cuts)
# Change type of time and date
cuts$Olay.Baþlangýç.Tarihi <- dmy_hm(cuts$Olay.Baþlangýç.Tarihi)
cuts$Olay.Bitiþ.Tarihi <- dmy_hm(cuts$Olay.Bitiþ.Tarihi)
# Turn power capacity variables into numeric
cuts$Ýþletmedeki.Kurulu.Güç <- gsub("[,\\.]","",cuts$Ýþletmedeki.Kurulu.Güç) 
cuts$Olay.Sýrasýnda.Kapasite<- gsub("[,\\.]","",cuts$Olay.Sýrasýnda.Kapasite) 
cuts$Ýþletmedeki.Kurulu.Güç <- as.factor(cuts$Ýþletmedeki.Kurulu.Güç)
cuts$Olay.Sýrasýnda.Kapasite <- as.factor(cuts$Olay.Sýrasýnda.Kapasite)
cuts$Ýþletmedeki.Kurulu.Güç <-as.numeric(levels(cuts$Ýþletmedeki.Kurulu.Güç))[cuts$Ýþletmedeki.Kurulu.Güç]
cuts$Olay.Sýrasýnda.Kapasite <-as.numeric(levels(cuts$Olay.Sýrasýnda.Kapasite))[cuts$Olay.Sýrasýnda.Kapasite]
cuts[c("Ýþletmedeki.Kurulu.Güç","Olay.Sýrasýnda.Kapasite")]<-cuts[c("Ýþletmedeki.Kurulu.Güç","Olay.Sýrasýnda.Kapasite")]/100
# Removing data that contains NA's.
cuts <- na.omit(cuts)
#Drop UEVÇB column, we do not think it will be any help for analysis.
cuts <- subset(cuts, select=-UEVÇB)
# Let's check the data for yearly total cuts.
yearly_cuts <- cuts %>% group_by(year=floor_date(Olay.Baþlangýç.Tarihi,"year")) %>% summarize(Olay.Baþlangýç.Tarihi=n())
yearly_cuts
```

Look like there is an average of 10-12k cuts per year in the database with the exception of 2018, where the number of cuts seems to be much higher. We believe this is simply the result of transparency platform adding more data from plants or more plants altogheter to its database in 2018 to make it more thorough.

```{r Plot}
# Let's put the yearly cuts into a bar graph.
ggplot(data=yearly_cuts, aes(y=Olay.Baþlangýç.Tarihi, x=factor(year(year)), fill=factor(year(year))))+
  geom_bar(stat="identity")+
  labs(x="Year", y="Incident Count", title="Yearly Total Incidents")+
  theme_light()+
  scale_fill_brewer(palette="PuBuGn")+
  theme(legend.position="none")
```
# Data Wrangling

The database has mostly text based data. Initial overview of the database shows a lot of errors, some of which come from localization problems, others simply misspelled. In this part, we've attempted to make it more tidy by making plant names more distinct, cut reasons more clear.

```{r New Variables For Calculations}
#Adding süre variable as duration of the cuts as hours and capacity usage ratio at time of cut as capacity usage's ratio to total capacity.

cuts <- cuts %>% mutate(sure = difftime(Olay.Bitiþ.Tarihi,Olay.Baþlangýç.Tarihi,units="hours")) %>% mutate(kapasiteorani = Olay.Sýrasýnda.Kapasite / Ýþletmedeki.Kurulu.Güç)

# Make all strings lower case so that can be cleaned easier.
cuts <- cuts %>% mutate_at(.vars=c("Santral.Ýsmi", "Gerekçe"), funs(tolower)) 

```

```{r Wrangle}
#Detect similiar names with Fuzzy Text matching
uniqueNames <- unique(cuts$Santral.Ýsmi)
name_distances <- list()
i <- 1
for (ind in uniqueNames){
  name_distances[[i]] <- agrep(ind, uniqueNames, value=T)
  i <- i+1
}
name_distances <- unique(Filter(function(x) {length(x) > 1}, name_distances))
#Fixing detected string issues.
cuts$Santral.Ýsmi <- cuts$Santral.Ýsmi %>% 
  str_replace_all("[Ýý]", "i") %>%
  str_replace_all("enerj.sa", "enerjisa") %>%
  str_replace_all("yeniköy ts", "yeniköy tes") %>%
  str_replace_all("^ova elektrik", "gebze ova elektrik") %>%
  str_replace_all("yataðan .*", "yataðan tes") %>%
  str_replace_all("köklüce$", "köklüce hes") %>%
  str_replace_all(".* entek", "entek") %>%
  str_replace_all("kürtün-hes", "kürtün hes") %>%
  str_replace_all("^rwe_turcas_guney", "denizli rwe_turcas_guney") %>%
  str_replace_all("tekirdað santrali.*", "modern enerji tekirdað santrali") %>%
  str_replace_all("karadað$", "karadað res") %>%
  str_replace_all(".?menzelet( hes)?", "menzelet hes") %>%
  str_replace_all("\\.", "") %>%
  str_replace_all("hidro(\\s?elektrik santral[ýi]| e\\.?s)", " hes") %>%
  str_replace_all("(termik santral[ýi]|\\sts\\s?)", " tes") %>%
  str_replace_all("tunçbilektes", "tunçbilek tes") %>%
  str_replace_all("d.*(k.*)?ç.*(s.*)?", "dgkç") %>%
  str_replace_all("jeotermal (e.*s.*)", "jes")
  
cuts$Gerekçe <- cuts$Gerekçe %>%
  str_replace_all("[Ýý]", "i") %>%
  str_replace_all("t(.r|r.)b.n", "türbin") %>%
  str_replace_all("ar.zas.?.?", "ariza") %>%
  str_replace_all("so.utma", "sogutma") %>%
  str_replace_all("(?<!\\d)\\.", "") %>%
  str_replace_all(".n.te", "unite") %>%
  str_replace_all("reg.lat.r", "regulator")
```

In order to categorise te reasons, we performed a word count Gerekçe column, laying out most encountered words.

```{r Word count of cut reasons}
gerekcewordcount <- cSplit(cuts, "Gerekçe", sep = " ", direction = "long") %>%
      group_by(Gerekçe) %>%
      summarise(Count = n())
arrange(gerekcewordcount,desc(Count))

```

Based on the plant name, we created a new column called Type which stores the type of the plant.

The abbreviations are as following:
HES : Hydroelectricty Plant
RES : Wind Energy Plant
TES : Thermal Power Plant
DGKÇ: Natural Gas Combined Cycle Plant
JES : Geothermal Energy Plant
BES : Biomass Energy Plant

```{r categorise Plant type}
#Categorising type of plants so we can do type based analysis later on.
cuts$Type <- ifelse(grepl(" hes\\s?", cuts$Santral.Ýsmi, ignore.case = T), "HES", 
         (ifelse(grepl(" res\\s?", cuts$Santral.Ýsmi, ignore.case = T), "RES",
         (ifelse(grepl(" tes\\s?", cuts$Santral.Ýsmi, ignore.case = T), "TES",
         (ifelse(grepl(" a?d.*k.*ç.*(s.*)?", cuts$Santral.Ýsmi, ignore.case = T), "DGKÇ",
         (ifelse(grepl("(jes\\s|jeotermal)", cuts$Santral.Ýsmi, ignore.case =T), "JES",
         (ifelse(grepl("biyokütle", cuts$Santral.Ýsmi, ignore.case =T), "BES",       
                "Other")))))))))))
cuts$Type <- as.factor(cuts$Type)
```

# Data Analysis

Let's take a look at our final dataset.

```{r Explore}
str(cuts)
```

Here are the explanations for variables:

Santral Ýsmi              : Name of the power plant.
Olay baþlangýç tarihi     : Start date time of the cut.
Olay bitiþ tarihi         : End date/time of the cut.
Ýþletmedeki kurulu güç    : Total power at the plant.
Olay sýrasýndaki kapasite : Capacity at the time of incident
Gerekçe                   : Reason of the cut
sure                      : Length of the cut in hours.
kapasiteoraný             : Proportion of the capacity at the time of the cut to max capacity.
Type                      : Type of the plant

```{r Capacity of Plants based on type}
cuts %>%
  group_by(Type) %>%
  summarize(Mean=mean(Ýþletmedeki.Kurulu.Güç)) %>%
  ggplot(., aes(x=reorder(Type, -Mean), y=Mean, fill=Type))+
    geom_bar(stat="identity")+
    labs(x="Plant Type", y="Power Output MWe", title="Average Power Output Based on Plant Type in Turkey")+
    theme_light()+
    scale_fill_brewer(palette="Greens")+
    theme(legend.position="none")
```

