---
title: "InitialAnalysis"
author: "Efehan Danýþman"
date: "11 Kasým 2018"
output: html_document
---

```{r setup, include=FALSE,eval=TRUE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(forcats)
library(scales)
library(knitr)
library(lubridate)
library(RColorBrewer)
library(plotly)
library(stringr)
library(splitstackshape)
```

## R Markdown

We obtained electricty cuts data in Turkey between 2012 and 2018 from the Energy Transparency Platform. Data contain 51630 rows and 7 variables.

Objectives of this project is as follows:

# Learning Objectives
* Cleaning dirty data and doing text mining in order to extract insights.
* Visualizing data according to different variables.
* Visualizing geographical data over the map.

# Analysis Objectives
* Finding longest and shortest cuts and visualizing them.
* Visualizing cuts at the power plants according to city and duration.
* Finding top reasons of electricity cuts with tidy text mining.
* Analyzing cuts vis-a-vis to capacity and total power at the power plant.

```{r Getting the Data}
# Create a temporary file
tmp<-tempfile(fileext=".csv")
# Download file from repository to the temp file
download.file("https://github.com/MEF-BDA503/gpj18-first/blob/master/dataset_candidates/ArizaBakim-01012008-25112018.csv?raw=True",destfile=tmp)
```

```{r Initial Cleaning and Analysis}
# Reading data. Encoding as Latin-1 is crucial in order to see Turkish characters properly.
cuts<-read.csv(tmp, encoding= "Latin-1", header=TRUE,row.names=NULL,sep=";")
# Checking what we have as data.
str(cuts)
# Convert type of time and date to date
cuts$Olay.Baþlangýç.Tarihi <- dmy_hm(cuts$Olay.Baþlangýç.Tarihi)
cuts$Olay.Bitiþ.Tarihi <- dmy_hm(cuts$Olay.Bitiþ.Tarihi)

# Turn power capacity variables into numeric. First clean the dots so they will not be considered as decimals while separating thousands. Then turn commas into dots so that we can have proper decimals.

cuts$Ýþletmedeki.Kurulu.Güç <- gsub("\\.","",cuts$Ýþletmedeki.Kurulu.Güç) 
cuts$Olay.Sýrasýnda.Kapasite<- gsub("\\.","",cuts$Olay.Sýrasýnda.Kapasite) 
cuts$Ýþletmedeki.Kurulu.Güç <- gsub(",",".",cuts$Ýþletmedeki.Kurulu.Güç) 
cuts$Olay.Sýrasýnda.Kapasite<- gsub(",",".",cuts$Olay.Sýrasýnda.Kapasite) 
cuts$Ýþletmedeki.Kurulu.Güç <- as.numeric(as.character(cuts$Ýþletmedeki.Kurulu.Güç))
cuts$Olay.Sýrasýnda.Kapasite <- as.numeric(as.character(cuts$Olay.Sýrasýnda.Kapasite))

#Verify that we finally have numeric values.
str(cuts$Ýþletmedeki.Kurulu.Güç)
str(cuts$Olay.Sýrasýnda.Kapasite)

# Looks like data is until beginning of the 2018 and we have between 10-12K cuts per year between 2014 and 2017.
yearly_cuts <- cuts %>% group_by(year=floor_date(Olay.Baþlangýç.Tarihi,"year")) %>% summarize(Olay.Baþlangýç.Tarihi=n())
yearly_cuts
```

```{r Plot}
# Let's put the yearly cuts into a bar graph.
ggplot(data=yearly_cuts, aes(y=Olay.Baþlangýç.Tarihi, x=factor(year(year)), fill=factor(year(year))))+
  geom_bar(stat="identity")+
  labs(x="Year", y="Incident Count", title="Yearly Total Incidents")+
  theme_light()+
  scale_fill_brewer(palette="PuBuGn")+
  theme(legend.position="none")
```

```{r New Variables For Calculations}
#Adding süre variable as duration of the cuts as hours and capacity usage ratio at time of cut as capacity usage's ratio to total capacity.
cuts <- cuts %>% mutate(sure = difftime(Olay.Bitiþ.Tarihi,Olay.Baþlangýç.Tarihi,units="hours")) %>% mutate(kapasiteorani = Olay.Sýrasýnda.Kapasite / Ýþletmedeki.Kurulu.Güç)
# Make all strings lower case so that can be cleaned easier.
cuts <- mutate_all(cuts, funs(tolower))
#Remove rows that contain NA's
cuts <- na.omit(cuts)
#Drop UEVÇB column, we do not think it will be any help for analysis.
cuts <- subset(cuts, select=-UEVÇB)

```

```{r Fuzzy string matching}

#Detect similiar names with Fuzzy Text matching
uniqueNames <- unique(cuts$Santral.İsmi)
name_distances <- list()
i <- 1
for (ind in uniqueNames){
  name_distances[[i]] <- agrep(ind, uniqueNames, value=T)
  i <- i+1
}
name_distances <- unique(Filter(function(x) {length(x) > 1}, name_distances))
#Fixing detected string issues.
cuts$Santral.İsmi <- cuts$Santral.İsmi %>% 
  str_replace_all("[İı]", "i") %>%
  str_replace_all("enerj.sa", "enerjisa") %>%
  str_replace_all("yeniköy ts", "yeniköy tes") %>%
  str_replace_all("^ova elektrik", "gebze ova elektrik") %>%
  str_replace_all("yatağan .*", "yatağan tes") %>%
  str_replace_all("köklüce$", "köklüce hes") %>%
  str_replace_all(".* entek", "entek") %>%
  str_replace_all("kürtün-hes", "kürtün hes") %>%
  str_replace_all("^rwe_turcas_guney", "denizli rwe_turcas_guney") %>%
  str_replace_all("tekirdağ santrali.*", "modern enerji tekirdağ santrali") %>%
  str_replace_all("karadağ$", "karadağ res") %>%
  str_replace_all(".?menzelet( hes)?", "menzelet hes") %>%
  str_replace_all("\\.", "") %>%
  str_replace_all("hidro(\\s?elektrik santral[ıi]| e\\.?s)", " hes") %>%
  str_replace_all("(termik santral[ıi]|\\sts\\s?)", " tes") %>%
  str_replace_all("tunçbilektes", "tunçbilek tes") %>%
  str_replace_all("d.*(k.*)?ç.*(s.*)?", "dgkç") %>%
  str_replace_all("jeotermal (e.*s.*)", "jes")
  
cuts$Gerekçe <- cuts$Gerekçe %>%
  str_replace_all("[İı]", "i") %>%
  str_replace_all("t(.r|r.)b.n", "türbin") %>%
  str_replace_all("ar.zas.?.?", "ariza") %>%
  str_replace_all("so.utma", "sogutma") %>%
  str_replace_all("(?<!\\d)\\.", "") %>%
  str_replace_all(".n.te", "unite") %>%
  str_replace_all("reg.lat.r", "regulator")
```


```{r Word count of cut reasons}

library(splitstackshape)
gerekcewordcount <- cSplit(cuts, "Gerekçe", sep = " ", direction = "long") %>%
      group_by(Gerekçe) %>%
      summarise(Count = n())

arrange(gerekcewordcount,desc(Count))
```

```{r categorise}
#Categorising type of plants so we can do type based analysis later on.
cuts$Plant.Type <- ifelse(grepl(" hes\\s?", cuts$Santral.İsmi, ignore.case = T), "HES", 
         (ifelse(grepl(" res\\s?", cuts$Santral.İsmi, ignore.case = T), "RES",
         (ifelse(grepl(" tes\\s?", cuts$Santral.İsmi, ignore.case = T), "TES",
         (ifelse(grepl(" a?d.*k.*ç.*(s.*)?", cuts$Santral.İsmi, ignore.case = T), "DGKÇ",
         (ifelse(grepl("jes\\s", cuts$Santral.İsmi, ignore.case =T), "JES",
                "Other")))))))))
cuts$Type <- as.factor(cuts$Type)
```
